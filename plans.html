<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Marketplace | WealthHedge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .ticker-wrap { background: #1d4ed8; color: white; overflow: hidden; white-space: nowrap; padding: 10px 0; }
        .ticker { display: inline-block; animation: ticker 40s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .plan-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-[#f8f9fa] min-h-screen pb-24">

    <div class="ticker-wrap text-[10px] font-bold uppercase tracking-widest sticky top-0 z-[60]">
        <div class="ticker">
            ðŸ’¹ LIVE UPDATES: New "PlanDetails" protocol active â€¢ Diversified portfolio tracking enabled â€¢ Instant maturity settlement for all community plans â€¢ ðŸ’Ž Total Assets Under Management: $2.4M
        </div>
    </div>

    <nav class="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-[36px] z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-chart-pie text-sm"></i>
            </div>
            <h1 class="text-xl font-bold">Wealth<span class="text-blue-600">Hedge</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <span id="user-email-display" class="hidden md:inline text-xs text-slate-400 font-medium"></span>
            <button onclick="logout()" class="text-red-500 text-sm font-bold px-4 py-2 hover:bg-red-50 rounded-lg transition">Logout</button>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 mt-8 space-y-12">
        
        <!-- Welcome & Balance -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h2 class="text-3xl font-bold text-slate-900">Investment <span class="text-blue-600">Plans</span></h2>
                <p class="text-slate-500 text-sm">Real-time marketplace driven by Spreadsheet Cloud.</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600">
                    <i class="fas fa-wallet"></i>
                </div>
                <div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-none">Your Balance</p>
                    <h3 id="u-balance" class="text-xl font-bold text-slate-800">...</h3>
                </div>
            </div>
        </div>

        <!-- Section: Active Portfolio -->
        <div class="space-y-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-chart-line text-blue-600"></i> Active Portfolio
            </h2>
            <div id="active-plans-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Loaded via JS -->
            </div>
        </div>

        <!-- Section: Dynamic Marketplace -->
        <div class="space-y-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-shop text-blue-600"></i> Spreadsheet Marketplace
            </h2>
            <div id="marketplace-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Loading State -->
                <div class="col-span-full py-20 text-center text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-blue-600"></i>
                    <p class="text-xs font-black uppercase tracking-widest">Syncing plans from database...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-3 flex justify-between items-center z-50 md:hidden">
        <button onclick="window.location.href='dashboard.html'" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-home text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
        <button onclick="window.location.href='plans.html'" class="flex flex-col items-center gap-1 text-blue-600"><i class="fas fa-chart-pie text-xl"></i><span class="text-[10px] font-bold">Plans</span></button>
        <button onclick="window.location.href='deposit.html'" class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg -mt-8 border-4 border-[#f8f9fa]"><i class="fas fa-plus"></i></button>
        <button onclick="window.location.href='history.html'" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-history text-xl"></i><span class="text-[10px] font-bold">History</span></button>
        <button onclick="window.location.href='profile.html'" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-user text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx6iX5Tj1mOXw2r06ghzuvfg9GktRvPE8bvKsyoXNcIs54mobNY2WOdDZ-Eh24oExgz/exec";
        const userToken = JSON.parse(localStorage.getItem('wh_user'));
        
        if(!userToken || !userToken.id) window.location.href = 'login.html';

        async function init() {
            document.getElementById('user-email-display').innerText = userToken.id;
            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'getAccountData', email: userToken.id }) 
                });
                const data = await res.json();
                
                document.getElementById('u-balance').innerText = `$${Number(data.balance || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                
                renderActivePlans(data.plans || []);
                renderMarketplace(data.marketplace || []);
            } catch (err) {
                console.error("Fetch Error:", err);
            }
        }

        function renderActivePlans(plans) {
            const container = document.getElementById('active-plans-container');
            if(plans.length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-3xl border border-dashed text-center text-slate-400 col-span-full"><p class="text-[10px] font-bold uppercase tracking-widest">No active investments</p></div>`;
                return;
            }
            container.innerHTML = plans.map(p => {
                const daysRemaining = Math.max(0, Math.ceil((new Date(p.expiry) - new Date()) / (1000 * 60 * 60 * 24)));
                return `
                <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between mb-3">
                        <span class="text-xs font-black text-slate-800">${p.name}</span>
                        <span class="text-[10px] text-blue-600 font-bold">${daysRemaining}D LEFT</span>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold">
                        <span class="text-slate-400">$${Number(p.amount).toLocaleString()} LOCKED</span>
                        <span class="text-green-600">ROI: $${Number(p.payout).toFixed(2)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderMarketplace(plans) {
            const container = document.getElementById('marketplace-container');
            if(plans.length === 0) {
                container.innerHTML = `<div class="col-span-full py-10 text-center text-slate-400">No plans configured in Spreadsheet.</div>`;
                return;
            }
            container.innerHTML = plans.map(p => `
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between plan-card hover:border-blue-400">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-${p.color || 'blue-600'}">
                                <i class="fas ${p.icon || 'fa-chart-pie'} text-lg"></i>
                            </div>
                            <span class="bg-blue-50 text-blue-600 text-[8px] font-black px-2 py-1 rounded-full uppercase tracking-widest">${p.category}</span>
                        </div>
                        <h4 class="font-bold text-slate-800 text-lg">${p.name}</h4>
                        <p class="text-3xl font-black text-blue-600 mb-2">${(p.rate * 100).toFixed(0)}% <span class="text-[10px] text-slate-400 font-normal">/${p.duration}d</span></p>
                        <p class="text-[10px] text-slate-500 leading-relaxed mb-4">${p.desc}</p>
                    </div>
                    <button onclick="processPurchase('${p.id}', '${p.name}', ${p.price})" class="w-full mt-4 bg-slate-900 text-white py-3 rounded-2xl font-black text-[10px] tracking-widest hover:bg-blue-600 transition-all">INVEST $${p.price}</button>
                </div>
            `).join('');
        }

        async function processPurchase(planId, planName, price) {
            if(!confirm(`Confirm $${price} investment for ${planName}?`)) return;
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'buyInvestment', email: userToken.id, planId: planId })
                });
                const result = await res.json();
                alert(result.msg);
                if(result.status === 'success') init();
            } catch (err) {
                alert("Network error.");
            } finally {
                btn.disabled = false;
                btn.innerText = `INVEST $${price}`;
            }
        }

        function logout() { localStorage.removeItem('wh_user'); window.location.href = 'login.html'; }
        init();
    </script>
</body>
</html>